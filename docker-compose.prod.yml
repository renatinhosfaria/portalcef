# =============================================================================
# Docker Compose for PRODUCTION
# Portal EssÃªncia Feliz - portalcef.com.br
# =============================================================================
# Deploy:    ./scripts/deploy.sh
# Logs:      docker compose -f docker-compose.prod.yml logs -f
# Stop:      docker compose -f docker-compose.prod.yml down
# =============================================================================

services:
  # ===========================================================================
  # Reverse Proxy - Traefik with Let's Encrypt SSL
  # ===========================================================================
  traefik:
    image: traefik:v3.0
    container_name: essencia-traefik
    command:
      # API and Dashboard
      - "--api.dashboard=true"
      - "--api.insecure=false"
      # Providers
      - "--providers.docker=true"
      - "--providers.docker.exposedbydefault=false"
      - "--providers.docker.network=essencia-prod"
      # Entrypoints
      - "--entrypoints.web.address=:80"
      - "--entrypoints.websecure.address=:443"
      # HTTP to HTTPS redirect
      - "--entrypoints.web.http.redirections.entrypoint.to=websecure"
      - "--entrypoints.web.http.redirections.entrypoint.scheme=https"
      # Let's Encrypt
      - "--certificatesresolvers.letsencrypt.acme.httpchallenge=true"
      - "--certificatesresolvers.letsencrypt.acme.httpchallenge.entrypoint=web"
      - "--certificatesresolvers.letsencrypt.acme.email=${ACME_EMAIL:-admin@portalcef.com.br}"
      - "--certificatesresolvers.letsencrypt.acme.storage=/letsencrypt/acme.json"
      # Logs
      - "--log.level=INFO"
      - "--accesslog=true"
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - "/var/run/docker.sock:/var/run/docker.sock:ro"
      - "letsencrypt_data:/letsencrypt"
    networks:
      - essencia-prod
    restart: unless-stopped
    labels:
      # Dashboard (optional - access via traefik.portalcef.com.br)
      - "traefik.enable=true"
      - "traefik.http.routers.dashboard.rule=Host(`traefik.${DOMAIN:-portalcef.com.br}`)"
      - "traefik.http.routers.dashboard.entrypoints=websecure"
      - "traefik.http.routers.dashboard.tls.certresolver=letsencrypt"
      - "traefik.http.routers.dashboard.service=api@internal"
      - "traefik.http.routers.dashboard.middlewares=auth"
      - "traefik.http.middlewares.auth.basicauth.users=${TRAEFIK_AUTH:-}"

  # ===========================================================================
  # Infrastructure Services
  # ===========================================================================
  postgres:
    image: postgres:16-alpine
    container_name: essencia-postgres
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-essencia}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_DB: ${POSTGRES_DB:-essencia_db}
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-essencia} -d ${POSTGRES_DB:-essencia_db}" ]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - essencia-prod
    restart: unless-stopped
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  redis:
    image: redis:7-alpine
    container_name: essencia-redis
    command: redis-server --appendonly yes
    volumes:
      - redis_data:/data
    healthcheck:
      test: [ "CMD", "redis-cli", "ping" ]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - essencia-prod
    restart: unless-stopped
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  minio:
    image: minio/minio:latest
    container_name: essencia-minio
    environment:
      MINIO_ROOT_USER: ${MINIO_ROOT_USER:-minioadmin}
      MINIO_ROOT_PASSWORD: ${MINIO_ROOT_PASSWORD}
    volumes:
      - minio_data:/data
    command: server /data --console-address ":9001"
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:9000/minio/health/live" ]
      interval: 30s
      timeout: 20s
      retries: 3
    networks:
      - essencia-prod
    restart: unless-stopped
    labels:
      # Storage API (api.portalcef.com.br/storage)
      - "traefik.enable=true"
      - "traefik.http.routers.minio.rule=Host(`storage.${DOMAIN:-portalcef.com.br}`)"
      - "traefik.http.routers.minio.entrypoints=websecure"
      - "traefik.http.routers.minio.tls.certresolver=letsencrypt"
      - "traefik.http.services.minio.loadbalancer.server.port=9000"

  # ===========================================================================
  # API (NestJS Backend)
  # ===========================================================================
  api:
    build:
      context: .
      dockerfile: services/api/Dockerfile
    container_name: essencia-api
    environment:
      NODE_ENV: production
      PORT: 3001
      DATABASE_URL: postgresql://${POSTGRES_USER:-essencia}:${POSTGRES_PASSWORD}@postgres:5432/${POSTGRES_DB:-essencia_db}
      REDIS_URL: redis://redis:6379
      COOKIE_SECRET: ${COOKIE_SECRET}
      COOKIE_DOMAIN: .${DOMAIN:-portalcef.com.br}
      SESSION_TTL_HOURS: ${SESSION_TTL_HOURS:-24}
      SESSION_RENEWAL_THRESHOLD: ${SESSION_RENEWAL_THRESHOLD:-0.25}
      MINIO_ENDPOINT: http://minio:9000
      MINIO_ACCESS_KEY: ${MINIO_ROOT_USER:-minioadmin}
      MINIO_SECRET_KEY: ${MINIO_ROOT_PASSWORD}
      MINIO_BUCKET: ${MINIO_BUCKET:-essencia-bucket}
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    healthcheck:
      test: [ "CMD", "wget", "--spider", "-q", "http://localhost:3001/health" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    networks:
      - essencia-prod
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 1G
        reservations:
          memory: 256M
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.api.rule=Host(`api.${DOMAIN:-portalcef.com.br}`)"
      - "traefik.http.routers.api.entrypoints=websecure"
      - "traefik.http.routers.api.tls.certresolver=letsencrypt"
      - "traefik.http.services.api.loadbalancer.server.port=3001"

  # ===========================================================================
  # Next.js Apps
  # ===========================================================================
  home:
    build:
      context: .
      dockerfile: Dockerfile.web
      args:
        APP_NAME: home
        APP_PORT: 3000
    container_name: essencia-home
    environment:
      NODE_ENV: production
      PORT: 3000
      NEXT_PUBLIC_API_URL: https://api.${DOMAIN:-portalcef.com.br}
      API_INTERNAL_URL: http://api:3001
    depends_on:
      - api
    networks:
      - essencia-prod
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 512M
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.home.rule=Host(`${DOMAIN:-portalcef.com.br}`) && !PathPrefix(`/login`) && !PathPrefix(`/usuarios`) && !PathPrefix(`/escolas`) && !PathPrefix(`/turmas`) && !PathPrefix(`/planejamento`) && !PathPrefix(`/loja`) && !PathPrefix(`/calendario`)"
      - "traefik.http.routers.home.entrypoints=websecure"
      - "traefik.http.routers.home.tls.certresolver=letsencrypt"
      - "traefik.http.routers.home.priority=1"
      - "traefik.http.services.home.loadbalancer.server.port=3000"

  login:
    build:
      context: .
      dockerfile: Dockerfile.web
      args:
        APP_NAME: login
        APP_PORT: 3003
    container_name: essencia-login
    environment:
      NODE_ENV: production
      PORT: 3003
      NEXT_PUBLIC_API_URL: https://api.${DOMAIN:-portalcef.com.br}
      API_INTERNAL_URL: http://api:3001
    depends_on:
      - api
    networks:
      - essencia-prod
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 512M
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.login.rule=Host(`${DOMAIN:-portalcef.com.br}`) && PathPrefix(`/login`)"
      - "traefik.http.routers.login.entrypoints=websecure"
      - "traefik.http.routers.login.tls.certresolver=letsencrypt"
      - "traefik.http.routers.login.priority=10"
      - "traefik.http.middlewares.login-strip.stripprefix.prefixes=/login"
      - "traefik.http.routers.login.middlewares=login-strip"
      - "traefik.http.services.login.loadbalancer.server.port=3003"

  usuarios:
    build:
      context: .
      dockerfile: Dockerfile.web
      args:
        APP_NAME: usuarios
        APP_PORT: 3004
    container_name: essencia-usuarios
    environment:
      NODE_ENV: production
      PORT: 3004
      NEXT_PUBLIC_API_URL: https://api.${DOMAIN:-portalcef.com.br}
      API_INTERNAL_URL: http://api:3001
    depends_on:
      - api
    networks:
      - essencia-prod
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 512M
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.usuarios.rule=Host(`${DOMAIN:-portalcef.com.br}`) && PathPrefix(`/usuarios`)"
      - "traefik.http.routers.usuarios.entrypoints=websecure"
      - "traefik.http.routers.usuarios.tls.certresolver=letsencrypt"
      - "traefik.http.routers.usuarios.priority=10"
      - "traefik.http.middlewares.usuarios-strip.stripprefix.prefixes=/usuarios"
      - "traefik.http.routers.usuarios.middlewares=usuarios-strip"
      - "traefik.http.services.usuarios.loadbalancer.server.port=3004"

  escolas:
    build:
      context: .
      dockerfile: Dockerfile.web
      args:
        APP_NAME: escolas
        APP_PORT: 3005
    container_name: essencia-escolas
    environment:
      NODE_ENV: production
      PORT: 3005
      NEXT_PUBLIC_API_URL: https://api.${DOMAIN:-portalcef.com.br}
      API_INTERNAL_URL: http://api:3001
    depends_on:
      - api
    networks:
      - essencia-prod
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 512M
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.escolas.rule=Host(`${DOMAIN:-portalcef.com.br}`) && PathPrefix(`/escolas`)"
      - "traefik.http.routers.escolas.entrypoints=websecure"
      - "traefik.http.routers.escolas.tls.certresolver=letsencrypt"
      - "traefik.http.routers.escolas.priority=10"
      - "traefik.http.middlewares.escolas-strip.stripprefix.prefixes=/escolas"
      - "traefik.http.routers.escolas.middlewares=escolas-strip"
      - "traefik.http.services.escolas.loadbalancer.server.port=3005"

  turmas:
    build:
      context: .
      dockerfile: Dockerfile.web
      args:
        APP_NAME: turmas
        APP_PORT: 3006
    container_name: essencia-turmas
    environment:
      NODE_ENV: production
      PORT: 3006
      NEXT_PUBLIC_API_URL: https://api.${DOMAIN:-portalcef.com.br}
      API_INTERNAL_URL: http://api:3001
    depends_on:
      - api
    networks:
      - essencia-prod
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 512M
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.turmas.rule=Host(`${DOMAIN:-portalcef.com.br}`) && PathPrefix(`/turmas`)"
      - "traefik.http.routers.turmas.entrypoints=websecure"
      - "traefik.http.routers.turmas.tls.certresolver=letsencrypt"
      - "traefik.http.routers.turmas.priority=10"
      - "traefik.http.middlewares.turmas-strip.stripprefix.prefixes=/turmas"
      - "traefik.http.routers.turmas.middlewares=turmas-strip"
      - "traefik.http.services.turmas.loadbalancer.server.port=3006"

  planejamento:
    build:
      context: .
      dockerfile: Dockerfile.web
      args:
        APP_NAME: planejamento
        APP_PORT: 3007
    container_name: essencia-planejamento
    environment:
      NODE_ENV: production
      PORT: 3007
      NEXT_PUBLIC_API_URL: https://api.${DOMAIN:-portalcef.com.br}
      API_INTERNAL_URL: http://api:3001
    depends_on:
      - api
    networks:
      - essencia-prod
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 512M
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.planejamento.rule=Host(`${DOMAIN:-portalcef.com.br}`) && PathPrefix(`/planejamento`)"
      - "traefik.http.routers.planejamento.entrypoints=websecure"
      - "traefik.http.routers.planejamento.tls.certresolver=letsencrypt"
      - "traefik.http.routers.planejamento.priority=10"
      - "traefik.http.middlewares.planejamento-strip.stripprefix.prefixes=/planejamento"
      - "traefik.http.routers.planejamento.middlewares=planejamento-strip"
      - "traefik.http.services.planejamento.loadbalancer.server.port=3007"

  loja:
    build:
      context: .
      dockerfile: Dockerfile.web
      args:
        APP_NAME: loja
        APP_PORT: 3010
    container_name: essencia-loja
    environment:
      NODE_ENV: production
      PORT: 3010
      NEXT_PUBLIC_API_URL: https://api.${DOMAIN:-portalcef.com.br}
      API_INTERNAL_URL: http://api:3001
    depends_on:
      - api
    networks:
      - essencia-prod
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 512M
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.loja.rule=Host(`${DOMAIN:-portalcef.com.br}`) && PathPrefix(`/loja`) && !PathPrefix(`/loja-admin`)"
      - "traefik.http.routers.loja.entrypoints=websecure"
      - "traefik.http.routers.loja.tls.certresolver=letsencrypt"
      - "traefik.http.routers.loja.priority=10"
      - "traefik.http.middlewares.loja-strip.stripprefix.prefixes=/loja"
      - "traefik.http.routers.loja.middlewares=loja-strip"
      - "traefik.http.services.loja.loadbalancer.server.port=3010"

  loja-admin:
    build:
      context: .
      dockerfile: Dockerfile.web
      args:
        APP_NAME: loja-admin
        APP_PORT: 3011
    container_name: essencia-loja-admin
    environment:
      NODE_ENV: production
      PORT: 3011
      NEXT_PUBLIC_API_URL: https://api.${DOMAIN:-portalcef.com.br}
      API_INTERNAL_URL: http://api:3001
    depends_on:
      - api
    networks:
      - essencia-prod
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 512M
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.loja-admin.rule=Host(`${DOMAIN:-portalcef.com.br}`) && PathPrefix(`/loja-admin`)"
      - "traefik.http.routers.loja-admin.entrypoints=websecure"
      - "traefik.http.routers.loja-admin.tls.certresolver=letsencrypt"
      - "traefik.http.routers.loja-admin.priority=15"
      - "traefik.http.middlewares.loja-admin-strip.stripprefix.prefixes=/loja-admin"
      - "traefik.http.routers.loja-admin.middlewares=loja-admin-strip"
      - "traefik.http.services.loja-admin.loadbalancer.server.port=3011"

  calendario:
    build:
      context: .
      dockerfile: Dockerfile.web
      args:
        APP_NAME: calendario
        APP_PORT: 3002
    container_name: essencia-calendario
    environment:
      NODE_ENV: production
      PORT: 3002
      NEXT_PUBLIC_API_URL: https://api.${DOMAIN:-portalcef.com.br}
      API_INTERNAL_URL: http://api:3001
    depends_on:
      - api
    networks:
      - essencia-prod
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 512M
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.calendario.rule=Host(`${DOMAIN:-portalcef.com.br}`) && PathPrefix(`/calendario`)"
      - "traefik.http.routers.calendario.entrypoints=websecure"
      - "traefik.http.routers.calendario.tls.certresolver=letsencrypt"
      - "traefik.http.routers.calendario.priority=10"
      - "traefik.http.middlewares.calendario-strip.stripprefix.prefixes=/calendario"
      - "traefik.http.routers.calendario.middlewares=calendario-strip"
      - "traefik.http.services.calendario.loadbalancer.server.port=3002"

networks:
  essencia-prod:
    driver: bridge
    name: essencia-prod

volumes:
  postgres_data:
    name: essencia-postgres-data-prod
  redis_data:
    name: essencia-redis-data-prod
  minio_data:
    name: essencia-minio-data-prod
  letsencrypt_data:
    name: essencia-letsencrypt-data
