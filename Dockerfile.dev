# syntax=docker/dockerfile:1.4
# =============================================================================
# Development Dockerfile for Portal Essencia Feliz Monorepo
# =============================================================================
# Usage: docker build -f Dockerfile.dev -t essencia-dev .
# Requires: DOCKER_BUILDKIT=1 (enabled by default in Docker 23+)
# =============================================================================

FROM node:22.12-alpine AS base

# OCI Labels for container metadata
LABEL org.opencontainers.image.title="Portal Essencia Feliz - Development"
LABEL org.opencontainers.image.description="Development environment for Portal Essencia Feliz monorepo"
LABEL org.opencontainers.image.vendor="Colegio Essencia Feliz"
LABEL org.opencontainers.image.version="1.0.0"

# Install required tools (wget for healthcheck, git for potential operations)
RUN apk add --no-cache libc6-compat git wget

# Disable corepack signature verification (workaround for key mismatch issue)
ENV COREPACK_ENABLE_STRICT=0
ENV COREPACK_ENABLE_DOWNLOAD_PROMPT=0

# Configure pnpm store location for caching
ENV PNPM_HOME="/pnpm"
ENV PATH="$PNPM_HOME:$PATH"

# Install pnpm directly to avoid corepack signature issues
RUN npm install -g pnpm@9.15.1

# Set working directory
WORKDIR /app

# =============================================================================
# Dependencies Stage - Install all workspace dependencies
# =============================================================================
FROM base AS deps

# Copy workspace configuration files first (for better cache)
COPY package.json pnpm-workspace.yaml pnpm-lock.yaml ./
COPY .npmrc* ./

# Copy all package.json files to leverage Docker cache
# Apps
COPY apps/home/package.json ./apps/home/
COPY apps/login/package.json ./apps/login/
COPY apps/usuarios/package.json ./apps/usuarios/
COPY apps/escolas/package.json ./apps/escolas/
COPY apps/planejamento/package.json ./apps/planejamento/

# Services
COPY services/api/package.json ./services/api/

# Packages
COPY packages/db/package.json ./packages/db/
COPY packages/shared/package.json ./packages/shared/
COPY packages/ui/package.json ./packages/ui/
COPY packages/components/package.json ./packages/components/
COPY packages/lib/package.json ./packages/lib/
COPY packages/config/package.json ./packages/config/
COPY packages/tailwind-config/package.json ./packages/tailwind-config/

# Install all dependencies with cache mount (avoids re-downloading packages)
RUN --mount=type=cache,id=pnpm,target=/pnpm/store \
    pnpm install --frozen-lockfile

# =============================================================================
# Development Stage - Runtime with hot-reload support
# =============================================================================
FROM base AS dev

# Create non-root user for security
# Using fixed UID/GID for consistency across environments
ARG UID=1001
ARG GID=1001
RUN addgroup -g ${GID} -S nodejs && \
    adduser -S nodejs -u ${UID} -G nodejs

# Copy node_modules from deps stage with ownership set directly (avoids slow chown -R)
# Using --link for faster copy when possible (BuildKit feature)
COPY --link --from=deps /app/node_modules ./node_modules

# Copy workspace package node_modules (using --link for speed)
COPY --link --from=deps /app/apps/home/node_modules ./apps/home/node_modules
COPY --link --from=deps /app/apps/login/node_modules ./apps/login/node_modules
COPY --link --from=deps /app/apps/usuarios/node_modules ./apps/usuarios/node_modules
COPY --link --from=deps /app/apps/escolas/node_modules ./apps/escolas/node_modules
COPY --link --from=deps /app/apps/planejamento/node_modules ./apps/planejamento/node_modules
COPY --link --from=deps /app/services/api/node_modules ./services/api/node_modules
COPY --link --from=deps /app/packages/db/node_modules ./packages/db/node_modules
COPY --link --from=deps /app/packages/shared/node_modules ./packages/shared/node_modules
COPY --link --from=deps /app/packages/ui/node_modules ./packages/ui/node_modules
COPY --link --from=deps /app/packages/components/node_modules ./packages/components/node_modules
COPY --link --from=deps /app/packages/lib/node_modules ./packages/lib/node_modules
COPY --link --from=deps /app/packages/config/node_modules ./packages/config/node_modules
COPY --link --from=deps /app/packages/tailwind-config/node_modules ./packages/tailwind-config/node_modules

# Copy workspace configuration (needed for pnpm/turbo)
COPY --link package.json pnpm-workspace.yaml pnpm-lock.yaml turbo.json ./
COPY .npmrc* ./

# Set environment for development
ENV NODE_ENV=development
ENV TURBO_TELEMETRY_DISABLED=1

# Expose all development ports
# API: 3001 | Login: 3003 | Usuarios: 3004 | Escolas: 3005 | Home: 3006 | Planejamento: 3007
EXPOSE 3001 3003 3004 3005 3006 3007

# Health check - verifies API is responding
# start-period gives time for initial build/startup
HEALTHCHECK --interval=30s --timeout=10s --start-period=120s --retries=3 \
  CMD wget --no-verbose --tries=1 --spider http://localhost:3001/health || exit 1

# Switch to non-root user
# Note: Can be overridden with --user root if needed for Windows volume permissions
USER nodejs

# Default command - runs all apps via Turborepo
CMD ["pnpm", "turbo", "dev"]
