events {
    worker_connections 1024;
}

http {
    # Reduz exposicao de informacao da versao
    server_tokens off;

    # Docker DNS resolver - resolve IPs dinamicamente a cada 10s
    resolver 127.0.0.11 valid=10s ipv6=off;
    resolver_timeout 5s;

    # Log dedicado para relatorios de CSP
    log_format csp_report escape=json '{'
        '"time":"$time_iso8601",'
        '"remote_addr":"$remote_addr",'
        '"host":"$host",'
        '"request":"$request",'
        '"status":$status,'
        '"body":$request_body'
    '}';

    # Log enxuto para POST / na loja (sem corpo, para evitar PII)
    log_format loja_post escape=json '{'
        '"time":"$time_iso8601",'
        '"remote_addr":"$remote_addr",'
        '"host":"$host",'
        '"request":"$request",'
        '"status":$status,'
        '"request_length":$request_length,'
        '"body_bytes_sent":$body_bytes_sent,'
        '"request_time":$request_time,'
        '"upstream_status":"$upstream_status",'
        '"upstream_response_time":"$upstream_response_time",'
        '"content_type":"$http_content_type",'
        '"content_length":"$http_content_length",'
        '"user_agent":"$http_user_agent",'
        '"referer":"$http_referer"'
    '}';

    map $host$request_method$request_uri $log_loja_post_root {
        default 0;
        "~^loja\\.portalcef\\.com\\.brPOST/$" 1;
    }

    # Rate limit por IP (proteção contra abuso e varredura)
    limit_req_status 429;
    limit_req_zone $binary_remote_addr zone=api_limit:10m rate=20r/s;
    limit_req_zone $binary_remote_addr zone=auth_limit:10m rate=5r/s;
    limit_req_zone $binary_remote_addr zone=shop_order_limit:10m rate=3r/s;
    limit_req_zone $binary_remote_addr zone=loja_api_limit:10m rate=20r/s;
    limit_req_zone $binary_remote_addr zone=loja_root_limit:10m rate=5r/s;
    limit_req_zone $binary_remote_addr zone=global_limit:10m rate=100r/s;

    # Blacklist de IPs maliciosos conhecidos
    geo $blocked_ip {
        default 0;
        65.108.120.157 1;  # Scanner ativo /adfa
        178.62.215.64 1;   # Brute force SSH
        188.166.101.37 1;  # Brute force SSH
        2.57.121.112 1;    # Brute force SSH
        20.81.183.82 1;    # Brute force SSH
        45.148.10.121 1;   # Brute force SSH
    }

    # Increase upload limit to 50MB
    client_max_body_size 50M;

    # ==========================================================================
    # PROXY CACHE CONFIGURATION (Otimização de Performance 2025)
    # ==========================================================================

    # Zona de cache para assets estáticos
    proxy_cache_path /var/cache/nginx/static
        levels=1:2
        keys_zone=static_cache:10m
        max_size=500m
        inactive=7d
        use_temp_path=off;

    # Zona de cache para API pública (endpoints que não mudam frequentemente)
    proxy_cache_path /var/cache/nginx/api
        levels=1:2
        keys_zone=api_cache:10m
        max_size=100m
        inactive=10m
        use_temp_path=off;

    # Headers para identificar cache hit/miss
    add_header X-Cache-Status $upstream_cache_status;

    # Redirect non-www to www (HTTP)
    server {
        listen 80;
        server_name portalcef.com.br;

        # Allow Let's Encrypt verification
        location /.well-known/acme-challenge/ {
            root /var/www/certbot;
        }

        location / {
            return 301 https://www.portalcef.com.br$request_uri;
        }
    }

    # Redirect HTTP to HTTPS (www)
    server {
        listen 80;
        server_name www.portalcef.com.br;

        # Allow Let's Encrypt verification
        location /.well-known/acme-challenge/ {
            root /var/www/certbot;
        }

        location / {
            return 301 https://$host$request_uri;
        }
    }

    # Redirect HTTP to HTTPS (loja)
    server {
        listen 80;
        server_name loja.portalcef.com.br;

        # Allow Let's Encrypt verification
        location /.well-known/acme-challenge/ {
            root /var/www/certbot;
        }

        location / {
            return 301 https://$host$request_uri;
        }
    }

    # Redirect non-www to www (HTTPS)
    server {
        listen 443 ssl;
        server_name portalcef.com.br;

        ssl_certificate /etc/letsencrypt/live/portalcef.com.br-0001/fullchain.pem;
        ssl_certificate_key /etc/letsencrypt/live/portalcef.com.br-0001/privkey.pem;

        ssl_protocols TLSv1.2 TLSv1.3;
        ssl_ciphers HIGH:!aNULL:!MD5;

        # Headers de seguranca (conservador)
        add_header X-Frame-Options "SAMEORIGIN" always;
        add_header X-Content-Type-Options "nosniff" always;
        add_header X-XSS-Protection "1; mode=block" always;
        add_header Referrer-Policy "no-referrer-when-downgrade" always;
        add_header Strict-Transport-Security "max-age=15552000; includeSubDomains" always;
        add_header Content-Security-Policy-Report-Only "default-src 'self'; base-uri 'self'; object-src 'none'; frame-ancestors 'self'; frame-src 'self'; img-src 'self' data: blob: https://api.dicebear.com https://ui-avatars.com; font-src 'self' data: https://fonts.gstatic.com; style-src 'self' 'unsafe-inline'; script-src 'self' 'unsafe-inline'; connect-src 'self' https://www.portalcef.com.br https://loja.portalcef.com.br; form-action 'self'; report-uri /csp-report" always;

        return 301 https://www.portalcef.com.br$request_uri;
    }

    # HTTPS Server (www)
    server {
        listen 443 ssl;
        server_name www.portalcef.com.br;

        ssl_certificate /etc/letsencrypt/live/portalcef.com.br-0001/fullchain.pem;
        ssl_certificate_key /etc/letsencrypt/live/portalcef.com.br-0001/privkey.pem;

        ssl_protocols TLSv1.2 TLSv1.3;
        ssl_ciphers HIGH:!aNULL:!MD5;

        # Bloquear IPs maliciosos conhecidos
        if ($blocked_ip) {
            return 444;
        }

        # Rate limit global (proteção DDoS)
        limit_req zone=global_limit burst=200 nodelay;

        # Headers de seguranca (conservador)
        add_header X-Frame-Options "SAMEORIGIN" always;
        add_header X-Content-Type-Options "nosniff" always;
        add_header X-XSS-Protection "1; mode=block" always;
        add_header Referrer-Policy "no-referrer-when-downgrade" always;
        add_header Strict-Transport-Security "max-age=15552000; includeSubDomains" always;
        add_header Content-Security-Policy-Report-Only "default-src 'self'; base-uri 'self'; object-src 'none'; frame-ancestors 'self'; frame-src 'self'; img-src 'self' data: blob: https://api.dicebear.com https://ui-avatars.com; font-src 'self' data: https://fonts.gstatic.com; style-src 'self' 'unsafe-inline'; script-src 'self' 'unsafe-inline'; connect-src 'self' https://www.portalcef.com.br https://loja.portalcef.com.br; form-action 'self'; report-uri /csp-report" always;

        location = /csp-report {
            set $upstream_api essencia-api:3002;
            proxy_pass http://$upstream_api/api/csp-report;
            proxy_http_version 1.1;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header Content-Type "application/json";
        }

        # Bloqueio de varredura comum (paths sensíveis)
        location ~* \\.env {
            return 444;
        }

        location ~* /\\.git {
            return 444;
        }

        location ~* /(wp-admin|wp-login\\.php|wordpress|phpmyadmin|server-status|wlwmanifest\\.xml) {
            return 444;
        }

        # Limite mais estrito para login
        location = /api/auth/login {
            limit_req zone=auth_limit burst=10 nodelay;
            set $upstream_api essencia-api:3002;
            proxy_pass http://$upstream_api;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection 'upgrade';
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_cache_bypass $http_upgrade;
        }

        # Limite mais estrito para criação/consulta de pedido
        location = /api/shop/orders {
            limit_req zone=shop_order_limit burst=6 nodelay;
            set $upstream_api essencia-api:3002;
            proxy_pass http://$upstream_api;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection 'upgrade';
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_cache_bypass $http_upgrade;
        }

        location ^~ /api/shop/orders/lookup {
            limit_req zone=shop_order_limit burst=6 nodelay;
            set $upstream_api essencia-api:3002;
            proxy_pass http://$upstream_api;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection 'upgrade';
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_cache_bypass $http_upgrade;
        }

        # API Proxy
        location /api {
            limit_req zone=api_limit burst=40 nodelay;
            set $upstream_api essencia-api:3002;
            proxy_pass http://$upstream_api;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection 'upgrade';
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_cache_bypass $http_upgrade;
        }

        # Health check
        location /health {
            set $upstream_api essencia-api:3002;
            proxy_pass http://$upstream_api/health;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
        }

        # Login App - arquivos estáticos do public (login-bg.jpg, etc.)
        # Esta regra deve vir ANTES da regra geral /login para capturar arquivos específicos
        location ~* ^/login/.*\.(jpg|jpeg|png|gif|ico|svg|woff|woff2|ttf|eot)$ {
            set $upstream_login essencia-login:3003;
            proxy_pass http://$upstream_login;
            proxy_http_version 1.1;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;

            proxy_cache static_cache;
            proxy_cache_valid 200 7d;
            proxy_cache_use_stale error timeout updating;
            add_header Cache-Control "public, max-age=604800";
            add_header X-Cache-Status $upstream_cache_status;
            access_log off;
        }

        # Login App
        location /login {
            set $upstream_login essencia-login:3003;
            proxy_pass http://$upstream_login;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection 'upgrade';
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_cache_bypass $http_upgrade;
        }

        # Usuarios App
        location /usuarios {
            set $upstream_usuarios essencia-usuarios:3004;
            proxy_pass http://$upstream_usuarios;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection 'upgrade';
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_cache_bypass $http_upgrade;
        }

        # Escolas App
        location /escolas {
            set $upstream_escolas essencia-escolas:3005;
            proxy_pass http://$upstream_escolas;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection 'upgrade';
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_cache_bypass $http_upgrade;
        }

        # Turmas App
        location /turmas {
            set $upstream_turmas essencia-turmas:3006;
            proxy_pass http://$upstream_turmas;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection 'upgrade';
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_cache_bypass $http_upgrade;
        }

        # Redirect /planejamentos to /planejamento/planejamentos (legacy URL fix)
        location = /planejamentos {
            return 301 /planejamento/planejamentos;
        }

        # Planejamento App
        location /planejamento {
            set $upstream_planejamento essencia-planejamento:3007;
            proxy_pass http://$upstream_planejamento;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection 'upgrade';
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_cache_bypass $http_upgrade;
        }

        # Tarefas App
        location /tarefas {
            set $upstream_tarefas essencia-tarefas:3012;
            proxy_pass http://$upstream_tarefas;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection 'upgrade';
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_cache_bypass $http_upgrade;
        }

        # Loja Admin App
        location /loja-admin {
            set $upstream_loja_admin essencia-loja-admin:3011;
            proxy_pass http://$upstream_loja_admin;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection 'upgrade';
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_cache_bypass $http_upgrade;
        }

        # Calendario App
        location /calendario {
            set $upstream_calendario essencia-calendario:3008;
            proxy_pass http://$upstream_calendario;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection 'upgrade';
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_cache_bypass $http_upgrade;
        }

        # Storage Proxy (MinIO) - ^~ para prioridade sobre regex de assets
        location ^~ /storage/ {
            proxy_pass http://minio:9000/;
            proxy_set_header Host minio:9000;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_connect_timeout 300;
            proxy_http_version 1.1;
            proxy_set_header Connection "";
            chunked_transfer_encoding off;
        }

        # =======================================================================
        # CACHE DE ASSETS ESTÁTICOS POR APLICAÇÃO (com basePath)
        # =======================================================================
        # IMPORTANTE: Estas regras devem vir ANTES das regras genéricas de cache
        # para que os assets de cada app sejam roteados corretamente.

        # Planejamento App - assets estáticos
        location ^~ /planejamento/_next/static/ {
            set $upstream_planejamento essencia-planejamento:3007;
            proxy_pass http://$upstream_planejamento;
            proxy_http_version 1.1;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;

            proxy_cache static_cache;
            proxy_cache_valid 200 365d;
            proxy_cache_use_stale error timeout updating http_500 http_502 http_503 http_504;
            proxy_cache_background_update on;
            proxy_cache_lock on;

            add_header Cache-Control "public, max-age=31536000, immutable";
            add_header X-Cache-Status $upstream_cache_status;
            access_log off;
        }

        # Login App - assets estáticos
        location ^~ /login/_next/static/ {
            set $upstream_login essencia-login:3003;
            proxy_pass http://$upstream_login;
            proxy_http_version 1.1;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;

            proxy_cache static_cache;
            proxy_cache_valid 200 365d;
            proxy_cache_use_stale error timeout updating http_500 http_502 http_503 http_504;
            proxy_cache_background_update on;
            proxy_cache_lock on;

            add_header Cache-Control "public, max-age=31536000, immutable";
            add_header X-Cache-Status $upstream_cache_status;
            access_log off;
        }

        # Usuarios App - assets estáticos
        location ^~ /usuarios/_next/static/ {
            set $upstream_usuarios essencia-usuarios:3004;
            proxy_pass http://$upstream_usuarios;
            proxy_http_version 1.1;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;

            proxy_cache static_cache;
            proxy_cache_valid 200 365d;
            proxy_cache_use_stale error timeout updating http_500 http_502 http_503 http_504;
            proxy_cache_background_update on;
            proxy_cache_lock on;

            add_header Cache-Control "public, max-age=31536000, immutable";
            add_header X-Cache-Status $upstream_cache_status;
            access_log off;
        }

        # Escolas App - assets estáticos
        location ^~ /escolas/_next/static/ {
            set $upstream_escolas essencia-escolas:3005;
            proxy_pass http://$upstream_escolas;
            proxy_http_version 1.1;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;

            proxy_cache static_cache;
            proxy_cache_valid 200 365d;
            proxy_cache_use_stale error timeout updating http_500 http_502 http_503 http_504;
            proxy_cache_background_update on;
            proxy_cache_lock on;

            add_header Cache-Control "public, max-age=31536000, immutable";
            add_header X-Cache-Status $upstream_cache_status;
            access_log off;
        }

        # Turmas App - assets estáticos
        location ^~ /turmas/_next/static/ {
            set $upstream_turmas essencia-turmas:3006;
            proxy_pass http://$upstream_turmas;
            proxy_http_version 1.1;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;

            proxy_cache static_cache;
            proxy_cache_valid 200 365d;
            proxy_cache_use_stale error timeout updating http_500 http_502 http_503 http_504;
            proxy_cache_background_update on;
            proxy_cache_lock on;

            add_header Cache-Control "public, max-age=31536000, immutable";
            add_header X-Cache-Status $upstream_cache_status;
            access_log off;
        }

        # Tarefas App - assets estáticos
        location ^~ /tarefas/_next/static/ {
            set $upstream_tarefas essencia-tarefas:3012;
            proxy_pass http://$upstream_tarefas;
            proxy_http_version 1.1;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;

            proxy_cache static_cache;
            proxy_cache_valid 200 365d;
            proxy_cache_use_stale error timeout updating http_500 http_502 http_503 http_504;
            proxy_cache_background_update on;
            proxy_cache_lock on;

            add_header Cache-Control "public, max-age=31536000, immutable";
            add_header X-Cache-Status $upstream_cache_status;
            access_log off;
        }

        # Loja Admin App - assets estáticos
        location ^~ /loja-admin/_next/static/ {
            set $upstream_loja_admin essencia-loja-admin:3011;
            proxy_pass http://$upstream_loja_admin;
            proxy_http_version 1.1;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;

            proxy_cache static_cache;
            proxy_cache_valid 200 365d;
            proxy_cache_use_stale error timeout updating http_500 http_502 http_503 http_504;
            proxy_cache_background_update on;
            proxy_cache_lock on;

            add_header Cache-Control "public, max-age=31536000, immutable";
            add_header X-Cache-Status $upstream_cache_status;
            access_log off;
        }

        # Calendario App - assets estáticos
        location ^~ /calendario/_next/static/ {
            set $upstream_calendario essencia-calendario:3008;
            proxy_pass http://$upstream_calendario;
            proxy_http_version 1.1;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;

            proxy_cache static_cache;
            proxy_cache_valid 200 365d;
            proxy_cache_use_stale error timeout updating http_500 http_502 http_503 http_504;
            proxy_cache_background_update on;
            proxy_cache_lock on;

            add_header Cache-Control "public, max-age=31536000, immutable";
            add_header X-Cache-Status $upstream_cache_status;
            access_log off;
        }

        # =======================================================================
        # CACHE DE ASSETS ESTÁTICOS (Home App - regra genérica fallback)
        # =======================================================================
        # Assets imutáveis com hash no nome - cache longo (1 ano)
        location ~* ^/_next/static/ {
            set $upstream_home essencia-home:3000;
            proxy_pass http://$upstream_home;
            proxy_http_version 1.1;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;

            # Cache agressivo para assets com hash
            proxy_cache static_cache;
            proxy_cache_valid 200 365d;
            proxy_cache_use_stale error timeout updating http_500 http_502 http_503 http_504;
            proxy_cache_background_update on;
            proxy_cache_lock on;

            # Headers de cache do browser
            add_header Cache-Control "public, max-age=31536000, immutable";
            add_header X-Cache-Status $upstream_cache_status;

            access_log off;
        }

        # Outros assets estáticos (imagens, fontes, etc.) - Home fallback
        location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
            set $upstream_home essencia-home:3000;
            proxy_pass http://$upstream_home;
            proxy_http_version 1.1;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;

            # Cache para assets estáticos
            proxy_cache static_cache;
            proxy_cache_valid 200 7d;
            proxy_cache_use_stale error timeout updating;

            # Headers de cache do browser
            add_header Cache-Control "public, max-age=604800";
            add_header X-Cache-Status $upstream_cache_status;

            access_log off;
        }

        # Home App (Root)
        location / {
            set $upstream_home essencia-home:3000;
            proxy_pass http://$upstream_home;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection 'upgrade';
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_cache_bypass $http_upgrade;
        }
    }

    # HTTPS Server (loja)
    server {
        listen 443 ssl;
        server_name loja.portalcef.com.br;

        ssl_certificate /etc/letsencrypt/live/portalcef.com.br-0001/fullchain.pem;
        ssl_certificate_key /etc/letsencrypt/live/portalcef.com.br-0001/privkey.pem;

        ssl_protocols TLSv1.2 TLSv1.3;
        ssl_ciphers HIGH:!aNULL:!MD5;

        # Bloquear IPs maliciosos conhecidos
        if ($blocked_ip) {
            return 444;
        }

        # Rate limit global (proteção DDoS)
        limit_req zone=global_limit burst=200 nodelay;

        # Increase upload limit to 50MB
        client_max_body_size 50M;

        # Headers de seguranca (conservador)
        add_header X-Frame-Options "SAMEORIGIN" always;
        add_header X-Content-Type-Options "nosniff" always;
        add_header X-XSS-Protection "1; mode=block" always;
        add_header Referrer-Policy "no-referrer-when-downgrade" always;
        add_header Strict-Transport-Security "max-age=15552000; includeSubDomains" always;
        add_header Content-Security-Policy-Report-Only "default-src 'self'; base-uri 'self'; object-src 'none'; frame-ancestors 'self'; frame-src 'self'; img-src 'self' data: blob: https://api.dicebear.com https://ui-avatars.com; font-src 'self' data: https://fonts.gstatic.com; style-src 'self' 'unsafe-inline'; script-src 'self' 'unsafe-inline'; connect-src 'self' https://www.portalcef.com.br https://loja.portalcef.com.br; form-action 'self'; report-uri /csp-report" always;

        location = /csp-report {
            set $upstream_api essencia-api:3002;
            proxy_pass http://$upstream_api/api/csp-report;
            proxy_http_version 1.1;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header Content-Type "application/json";
        }

        access_log /dev/stdout loja_post if=$log_loja_post_root;

        # NOTE: Há location /api aqui apenas para rate limit.
        # As requisições /api continuam sendo tratadas pelo Next.js da loja
        # (Route Handlers) que fazem proxy para o backend usando API_INTERNAL_URL

        # Bloqueio de varredura comum (paths sensíveis)
        location ~* \\.env {
            return 444;
        }

        location ~* /\\.git {
            return 444;
        }

        location ~* /(wp-admin|wp-login\\.php|wordpress|phpmyadmin|server-status|wlwmanifest\\.xml) {
            return 444;
        }

        # Rate limit específico para APIs da loja
        location /api {
            limit_req zone=loja_api_limit burst=40 nodelay;
            set $upstream_loja essencia-loja:3010;
            proxy_pass http://$upstream_loja;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection 'upgrade';
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_cache_bypass $http_upgrade;
        }

        # Storage Proxy (MinIO - para imagens dos produtos) - ^~ para prioridade
        location ^~ /storage/ {
            proxy_pass http://minio:9000/;
            proxy_set_header Host minio:9000;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_connect_timeout 300;
            proxy_http_version 1.1;
            proxy_set_header Connection "";
            chunked_transfer_encoding off;
        }

        # Loja App (root path)
        location = / {
            limit_req zone=loja_root_limit burst=10 nodelay;
            set $upstream_loja essencia-loja:3010;
            proxy_pass http://$upstream_loja;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection 'upgrade';
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_cache_bypass $http_upgrade;
        }

        location / {
            set $upstream_loja essencia-loja:3010;
            proxy_pass http://$upstream_loja;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection 'upgrade';
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_cache_bypass $http_upgrade;
        }
    }
}
